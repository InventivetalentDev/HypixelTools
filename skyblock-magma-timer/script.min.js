$(document).ready(function(){$("#infoModal").modal(),$("#timelineModal").modal({onOpenEnd:function(){v()}}),$("#confirmationModal").modal({onCloseStart:function(){$("#addEventType").val(""),$("#captchaConfirmSubmit").hide()}}),$("#eventInfoModal").modal({onOpenEnd:function(){$("#blazeWaveVideo")[0].play(),$("#magmaWaveVideo")[0].play(),$("#magmaBossVideo")[0].play()}}),$(".track-btn.tooltipped").tooltip({position:"left"});try{grecaptcha.ready(function(){console.log("recaptcha ready"),$(".track-btn").attr("disabled",!1)})}catch(t){console.warn(t)}"#DEV"===window.location.hash&&$("#d").text("DEV MODE ACTIVE");let t,e,a=(new Date).getTime(),n=12e5,o=6e5,i=3e5,s=0,l={},m=-1,r=4,c=a/1e3,d="",p="",h=!1,f=!1;function u(){a=Date.now(),s++;let m=moment.duration(a-l.latest.spawn).asHours(),r=moment.duration(a-l.latest.death).asHours(),c=moment.duration(l.estimate-a).asMinutes(),d=moment.duration(a-l.latest.spawn).asMinutes(),p=moment.duration(a-l.latest.blaze).asMinutes(),h=moment.duration(a-l.latest.magma).asMinutes(),f=moment.duration(a-l.latest.music).asMinutes();$("#nextTime").text("("+moment(l.estimate).format("MMMM Do YYYY, h:mm:ss a")+")");let u=l.latest.death>l.latest.spawn,g=u?l.latest.death:l.latest.spawn;$("#lastTrackedType").text(u?"death":"spawn"),$("#lastTrackedTime").html(moment(g).fromNow()+"<br/> ("+moment(g).format("MMMM Do YYYY, h:mm:ss a")+")"+(m>5&&r>5?"<br/><i>The timer could likely be inaccurate, since server restarts etc. are not accounted for</i>":"")),l.latest.death<=0&&l.latest.spawn<=0&&$("#lastTrackedWrapper").hide();let w=l.estimate-a,b=moment.utc(w).format("HH:mm:ss");w>0?($("#time").text(b),$("#timerText").text("The Magma Boss should spawn in about"),$("head title",window.parent.document).text(b+" | Magma Boss Timer // Hypixel Skyblock")):($("#time").text("NOW"),$("#timerText").text("The Magma Boss should spawn"),$("head title",window.parent.document).text("NOW | Magma Boss Timer // Hypixel Skyblock")),s>15&&a%2==0&&(c>25&&l.confidence>.3?$("#waveBlazeBtn").hide():$("#waveBlazeBtn").show(),(p<30&&p>5||0===l.latest.blaze&&h<30&&h>1)&&$("#waveBlazeBtn").attr("disabled",!0),a-l.latest.blaze<n?($("#waveBlazeTime").text("("+moment(l.latest.blaze).fromNow()+")"),$("#waveBlazeBtn").attr("data-tooltip",l.latestConfirmations.blaze+" Confirmations")):($("#waveBlazeTime").text(""),$("#waveBlazeBtn").attr("data-tooltip","Not Confirmed")),c>15&&l.confidence>.3?$("#waveMagmaBtn").hide():$("#waveMagmaBtn").show(),(h<30&&h>5||0===l.latest.magma&&f<30&&f>1)&&$("#waveMagmaBtn").attr("disabled",!0),a-l.latest.magma<o?($("#waveMagmaTime").text("("+moment(l.latest.magma).fromNow()+")"),$("#waveMagmaBtn").attr("data-tooltip",l.latestConfirmations.magma+" Confirmations")):($("#waveMagmaTime").text(""),$("#waveMagmaBtn").attr("data-tooltip","Not Confirmed")),c>5&&l.confidence>.3?$("#musicBtn").hide():$("#musicBtn").show(),f<30&&f>5&&$("#musicBtn").attr("disabled",!0),a-l.latest.music<i?($("#musicTime").text("("+moment(l.latest.music).fromNow()+")"),$("#musicBtn").attr("data-tooltip",l.latestConfirmations.music+" Confirmations")):($("#musicTime").text(""),$("#musicBtn").attr("data-tooltip","Not Confirmed")),c>4&&d>1&&l.confidence>.3?$("#spawnedBtn").hide():$("#spawnedBtn").show(),a-l.latest.spawn<i?($("#spawnTime").text("("+moment(l.latest.spawn).fromNow()+")"),$("#spawnedBtn").attr("data-tooltip",l.latestConfirmations.spawn+" Confirmations")):($("#spawnTime").text(""),$("#spawnedBtn").attr("data-tooltip","Not Confirmed")),c>1&&d>2&&l.confidence>.3?$("#deathBtn").hide():$("#deathBtn").show(),a-l.latest.death<i?($("#deathTime").text("("+moment(l.latest.death).fromNow()+")"),$("#deathBtn").attr("data-tooltip",l.latestConfirmations.death+" Confirmations")):($("#deathTime").text(""),$("#deathBtn").attr("data-tooltip","Not Confirmed")),$(".track-btn.tooltipped").tooltip({position:"left"}),$(".track-btn:visible").length?$("#buttonNote").show():$("#buttonNote").hide());let v="";w<i?(v="Get ready!","true"===localStorage.getItem("fiveMinNotification")&&(e||(e=M("The Skyblock Magma Boss should spawn in less than five minutes!")))):e=null,w<o?(v="If you're not already in the Blazing Fortress, you should get going!","true"===localStorage.getItem("tenMinNotification")&&(t||e||(t=M("The Skyblock Magma Boss should spawn in less than 10 minutes!")))):t=null,$("#suggestionMessage").text(v)}function g(){$.ajax("https://hypixel-api.inventivetalent.org/api/skyblock/bosstimer/magma/estimatedSpawn").done(function(t){console.log(t),l=t,u(),clearInterval(m),m=setInterval(u,1e3)})}function w(){$.ajax({method:"POST",url:"https://hypixel-api.inventivetalent.org/api/skyblock/bosstimer/magma/ping",data:{lastFocused:Math.floor(c),minecraftUser:$("#mcUsername").val(),ipv4:d,ipv6:p}})}function b(t,e,a,n){!function(t){$("#addEventType").val(t),$("#confirmationModal").modal("open")}(e),t.attr("disabled",!0)}function v(){$.ajax("https://hypixel-api.inventivetalent.org/api/skyblock/bosstimer/magma/historyChart?hours="+r).done(function(t){Highcharts.chart("timelineChart",{chart:{zoomType:"x",type:"timeline",height:"20%",backgroundColor:"rgb(55, 40, 47)",marginLeft:80,marginRight:80},xAxis:{type:"datetime",visible:!1},yAxis:{gridLineWidth:1,title:null,labels:{enabled:!1}},legend:{enabled:!1},title:{text:null},tooltip:{style:{},formatter:function(){let t=Highcharts.dateFormat("%y-%m-%d",this.x),e=Highcharts.dateFormat("%H:%M:%S",this.x);return`<span style="color:${this.point.color}">●</span> ${this.point.name}<br/>`+`<span>${t} <b>${e}</b></span><br/>`+`<span>(${this.point.confirmations} confirmations)</span>`},headerFormat:'<span style="color:{point.color}">●</span> {point.key}<br/>',pointFormat:"<span>{point.x:%y-%m-%d} <b>{point.x:%H:%M:%S}</b></span><br/>",footerFormat:""},series:[{dataLabels:{allowOverlap:!1},marker:{symbol:"circle"},data:t.chart}]})})}function M(t,e){if("Notification"in window)if("granted"===Notification.permission){if(!f||!h)return new Notification(e||"Magma Boss Reminder",{body:t,icon:"https://hypixel.inventivetalent.org/img/Magma_Cube_50px.png"});console.log("OneSignal push notifications are enabled, not sending another one.")}else console.warn("Notifications not granted");else console.warn("Browser does not support notifications")}g(),setInterval(g,3e4),w(),setInterval(w,3e4),$("#waveBlazeBtn").click(function(){b($(this),"blaze","a blaze wave",!1)}),$("#waveMagmaBtn").click(function(){b($(this),"magma","a magma wave",!1)}),$("#musicBtn").click(function(){b($(this),"music","music",!1)}),$("#spawnedBtn").click(function(){b($(this),"spawn","a boss spawn",!1)}),$("#deathBtn").click(function(){b($(this),"death","a boss death",!0)}),$("#eventConfirmationForm").on("submit",function(t){t.preventDefault(),$("#captchaConfirmSubmit").attr("disabled",!0);let e=$("#addEventType").val();if(!e)return;let a=grecaptcha.getResponse(),n=$("#mcUsername").val();$.ajax({method:"POST",url:"https://hypixel-api.inventivetalent.org/api/skyblock/bosstimer/magma/addEvent",data:{type:e,captcha:a,username:n,ipv4:d,ipv6:p}}).done(function(){$("#confirmationModal").modal("close"),g()})}),$("#tenMinNotificationSwitch").prop("checked","true"===localStorage.getItem("tenMinNotification")&&"granted"===Notification.permission),$("#tenMinNotificationSwitch").change(function(){$(this).is(":checked")?Notification.requestPermission().then(function(t){console.log(t),localStorage.setItem("tenMinNotification","true")}):localStorage.setItem("tenMinNotification","false")}),$("#fiveMinNotificationSwitch").prop("checked","true"===localStorage.getItem("fiveMinNotification")&&"granted"===Notification.permission),$("#fiveMinNotificationSwitch").change(function(){$(this).is(":checked")?Notification.requestPermission().then(function(t){console.log(t),localStorage.setItem("fiveMinNotification","true")}):localStorage.setItem("fiveMinNotification","false")}),OneSignal.push(["getNotificationPermission",function(t){console.log("OnePush Site Notification Permission:",t),h="granted"===t}]),OneSignal.push(function(){OneSignal.on("subscriptionChange",function(t){console.log("The user's subscription state is now:",t),f=t}),OneSignal.isPushNotificationsEnabled(function(t){t?console.log("Push notifications are enabled!"):console.log("Push notifications are not enabled yet."),f=t})}),$("#mcUsername").val(localStorage.getItem("mcUsername")||""),$("#mcUsername").on("change",function(){localStorage.setItem("mcUsername",$(this).val())}),Highcharts.setOptions({time:{useUTC:!1}}),$("#timelineLoadMore").click(function(){r<24?r+=2:$(this).attr("disabled",!0),v()}),$(window).on("focus blur",function(){c=Date.now()/1e3}),$.getJSON("https://api.ipify.org?format=jsonp&callback=?",function(t){d=t.ip,console.log("IPv4: "+d)}),$.getJSON("https://api6.ipify.org?format=jsonp&callback=?",function(t){p=t.ip,console.log("IPv6: "+p)})});
